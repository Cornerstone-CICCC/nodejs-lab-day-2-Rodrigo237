<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-12 col-md-6">
          <div class="card p-4 shadow-sm profile d-none">
            <h1 class="mb-3">Profile</h1>
            <h3>Username: <span id="usernameSpan"></span></h3>
            <h4>First Name: <span id="firstNameSpan"></span></h4>
            <h4>Last Name: <span id="lastNameSpan"></span></h4>
            <button id="btn-logout" class="btn btn-outline-danger mt-3">Log Out</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Get account details
      const getUserbyName = async () => {
        try {
          const res = await fetch("http://localhost:3700/users/profile", {
            credentials: "include" // include cookies
          })
          const data = await res.json()
          if (!res.ok) {
            alert(data.message)
            window.location.href = "/"
            return
          }
          console.log(data)
          const profile = document.querySelector('.profile')
          if (profile instanceof HTMLElement) profile.classList.remove('d-none')
          const usernameSpan = document.getElementById('usernameSpan')
          if (usernameSpan instanceof HTMLElement) usernameSpan.textContent = data.username
          const firstNameSpan = document.getElementById('firstNameSpan')
          if (firstNameSpan instanceof HTMLElement) firstNameSpan.textContent = data.firstName || ''
          const lastNameSpan = document.getElementById('lastNameSpan')
          if (lastNameSpan instanceof HTMLElement) lastNameSpan.textContent = data.lastName || ''
        } catch (err) {
          console.error(err)
        }
      }

      // Use a concrete path that matches the backend route pattern and include cookies
      getUserbyName()

      // Log out
      const btnLogout = document.getElementById('btn-logout')
      if (btnLogout instanceof HTMLElement) {
        btnLogout.addEventListener('click', async () => {
          try {
            await fetch("http://localhost:3700/users/logout", {
              credentials: "include"
            })
            window.location.href = "/" // redirect to home
          } catch (err) {
            console.error(err)
          }
        })
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>